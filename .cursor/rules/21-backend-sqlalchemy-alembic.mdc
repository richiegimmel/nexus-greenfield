---
alwaysApply: false
globs:
  - "backend/app/modules/**/models.py"
  - "backend/app/platform/**"
  - "backend/alembic/**"
  - "backend/**/migrations/**"
---

# SQLAlchemy & Alembic Conventions

## SQLAlchemy models
- Use the declarative base from `backend/app/platform/database.py`.
- Each module defines its own models in `models.py`; tables are owned by that module.
- No cross-module ORM relationships (no ForeignKey to another module's table in the ORM model). Reference other modules by ID column only.
- Use `Mapped[]` type annotations (SQLAlchemy 2.x style).
- Always define `__tablename__` explicitly; prefix with module name.
- Include `created_at` and `updated_at` timestamps on mutable tables.
- Ledger/audit tables must NOT have `updated_at`; they are append-only.

## Session management
- Use a shared session factory from platform (`get_db` dependency).
- One session per request (unit-of-work pattern).
- Services receive the session via dependency injection; they do not create sessions.
- Commit at the API layer or via an explicit unit-of-work boundary, not inside service functions.

## Alembic migrations
- One migration per schema change, per PR.
- Migration files must be reviewable: no autogenerated blobs without cleanup.
- Always provide both `upgrade()` and `downgrade()`.
- Data migrations go in separate migration files from schema migrations.
- Test that migrations apply cleanly on an empty database (`make migrate` from scratch).
- Never modify a migration that has been merged to `main`.
